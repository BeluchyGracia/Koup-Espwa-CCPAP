<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Admin Calendrier</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Styles pour l'arbre de tournoi */
        .bracket-container {
            display: flex;
            justify-content: center;
            overflow-x: auto;
            padding: 20px 0;
            margin-top: 20px;
        }

        .bracket-round {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            margin: 0 15px;
            min-width: 200px;
        }

        .round-title {
            text-align: center;
            background-color: #2c3e50;
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .match-pair {
            position: relative;
            margin: 15px 0;
        }

        .match-team {
            padding: 8px 12px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 2px 0;
            width: 160px;
            position: relative;
        }

        .match-team select {
            width: 100%;
            border: none;
            background: transparent;
        }

        .final .match-team:after {
            display: none;
        }

        .winner {
            background-color: #f1c40f;
            font-weight: bold;
        }

        /* Styles pour les groupes */
        .groups-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .group {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 280px;
        }

        .group-header {
            background-color: #2c3e50;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }

        .team-list {
            padding: 10px;
            margin: 0;
            list-style: none;
        }

        .team-item {
            margin-bottom: 5px;
        }

        .team-item select {
            width: 100%;
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-5">
        <h2 class="mb-4 text-center">Gestion du Calendrier</h2>
     

        <!-- Section pour configurer les groupes -->
        <div class="mt-5">
            <h3 class="text-center mb-4">Configuration des Groupes</h3>
            
            <div class="groups-container" id="groupsContainer">
                <div class="group">
                    <div class="group-header">Groupe A</div>
                    <ul class="team-list">
                        <li class="team-item">
                            <select class="form-select groupeA">
                                <option value="">Sélectionner équipe</option>
                            </select>
                        </li>
                        <li class="team-item">
                            <select class="form-select groupeA">
                                <option value="">Sélectionner équipe</option>
                            </select>
                        </li>
                        <li class="team-item">
                            <select class="form-select groupeA">
                                <option value="">Sélectionner équipe</option>
                            </select>
                        </li>
                        <li class="team-item">
                            <select class="form-select groupeA">
                                <option value="">Sélectionner équipe</option>
                            </select>
                        </li>
                    </ul>
                </div>
                
                <div class="group">
                    <div class="group-header">Groupe B</div>
                    <ul class="team-list">
                        <li class="team-item">
                            <select class="form-select groupeB">
                                <option value="">Sélectionner équipe</option>
                            </select>
                        </li>
                        <li class="team-item">
                            <select class="form-select groupeB">
                                <option value="">Sélectionner équipe</option>
                            </select>
                        </li>
                        <li class="team-item">
                            <select class="form-select groupeB">
                                <option value="">Sélectionner équipe</option>
                            </select>
                        </li>
                        <li class="team-item">
                            <select class="form-select groupeB">
                                <option value="">Sélectionner équipe</option>
                            </select>
                        </li>
                    </ul>
                </div>
                
                <div class="group">
                    <div class="group-header">Groupe C</div>
                    <ul class="team-list">
                        <li class="team-item">
                            <select class="form-select groupeC">
                                <option value="">Sélectionner équipe</option>
                            </select>
                        </li>
                        <li class="team-item">
                            <select class="form-select groupeC">
                                <option value="">Sélectionner équipe</option>
                            </select>
                        </li>
                        <li class="team-item">
                            <select class="form-select groupeC">
                                <option value="">Sélectionner équipe</option>
                            </select>
                        </li>
                        <li class="team-item">
                            <select class="form-select groupeC">
                                <option value="">Sélectionner équipe</option>
                            </select>
                        </li>
                    </ul>
                </div>
                
                <div class="group">
                    <div class="group-header">Groupe D</div>
                    <ul class="team-list">
                        <li class="team-item">
                            <select class="form-select groupeD">
                                <option value="">Sélectionner équipe</option>
                            </select>
                        </li>
                        <li class="team-item">
                            <select class="form-select groupeD">
                                <option value="">Sélectionner équipe</option>
                            </select>
                        </li>
                        <li class="team-item">
                            <select class="form-select groupeD">
                                <option value="">Sélectionner équipe</option>
                            </select>
                        </li>
                        <li class="team-item">
                            <select class="form-select groupeD">
                                <option value="">Sélectionner équipe</option>
                            </select>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Section pour configurer l'arbre de tournoi -->
        <div class="mt-5">
            <h3 class="text-center mb-4">Configuration de l'arbre de tournoi</h3>
            
            <div class="bracket" id="bracketContainer">
                <div class="bracket-container">
                    <!-- Quarts de finale -->
                    <div class="bracket-round">
                        <div class="round-title">Quarts de finale</div>
                        <div class="match-pair">
                            <div class="match-team">
                                <select class="form-select quart-equipe" id="quart1_equipe1">
                                    <option value="">Sélectionner équipe</option>
                                </select>
                            </div>
                            <div class="match-team">
                                <select class="form-select quart-equipe" id="quart1_equipe2">
                                    <option value="">Sélectionner équipe</option>
                                </select>
                            </div>
                        </div>
                        <div class="match-pair">
                            <div class="match-team">
                                <select class="form-select quart-equipe" id="quart2_equipe1">
                                    <option value="">Sélectionner équipe</option>
                                </select>
                            </div>
                            <div class="match-team">
                                <select class="form-select quart-equipe" id="quart2_equipe2">
                                    <option value="">Sélectionner équipe</option>
                                </select>
                            </div>
                        </div>
                        <div class="match-pair">
                            <div class="match-team">
                                <select class="form-select quart-equipe" id="quart3_equipe1">
                                    <option value="">Sélectionner équipe</option>
                                </select>
                            </div>
                            <div class="match-team">
                                <select class="form-select quart-equipe" id="quart3_equipe2">
                                    <option value="">Sélectionner équipe</option>
                                </select>
                            </div>
                        </div>
                        <div class="match-pair">
                            <div class="match-team">
                                <select class="form-select quart-equipe" id="quart4_equipe1">
                                    <option value="">Sélectionner équipe</option>
                                </select>
                            </div>
                            <div class="match-team">
                                <select class="form-select quart-equipe" id="quart4_equipe2">
                                    <option value="">Sélectionner équipe</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Demi-finales -->
                    <div class="bracket-round">
                        <div class="round-title">Demi-finales</div>
                        <div class="match-pair">
                            <div class="match-team">
                                <select class="form-select demi-equipe" id="demi1_equipe1">
                                    <option value="">Sélectionner équipe</option>
                                </select>
                            </div>
                            <div class="match-team">
                                <select class="form-select demi-equipe" id="demi1_equipe2">
                                    <option value="">Sélectionner équipe</option>
                                </select>
                            </div>
                        </div>
                        <div class="match-pair">
                            <div class="match-team">
                                <select class="form-select demi-equipe" id="demi2_equipe1">
                                    <option value="">Sélectionner équipe</option>
                                </select>
                            </div>
                            <div class="match-team">
                                <select class="form-select demi-equipe" id="demi2_equipe2">
                                    <option value="">Sélectionner équipe</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Finale -->
                    <div class="bracket-round final">
                        <div class="round-title">Finale</div>
                        <div class="match-pair">
                            <div class="match-team">
                                <select class="form-select final-equipe" id="final_equipe1">
                                    <option value="">Sélectionner équipe</option>
                                </select>
                            </div>
                            <div class="match-team">
                                <select class="form-select final-equipe" id="final_equipe2">
                                    <option value="">Sélectionner équipe</option>
                                </select>
                            </div>
                        </div>
                        <div class="match-team winner">
                            <select class="form-select" id="vainqueur">
                                <option value="">Sélectionner vainqueur</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center mt-4">
                <button id="saveTournament" class="btn btn-primary btn-lg">Enregistrer la configuration</button>
            </div>
        </div>
    </div>

   <script>
    // Charger les équipes depuis la base de données
    async function chargerEquipes() {
        try {
            const response = await fetch('/api/equipes');
            if (!response.ok) throw new Error('Erreur réseau');
            
            const equipes = await response.json();
            
            // Remplir tous les dropdowns
            const selects = document.querySelectorAll('.form-select');
            selects.forEach(select => {
                // Garder l'option par défaut
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                // Ajouter les équipes
                equipes.forEach(equipe => {
                    const option = document.createElement('option');
                    option.value = equipe.id;
                    option.textContent = equipe.nom;
                    option.setAttribute('data-nom', equipe.nom); // Stocker le nom en attribut
                    select.appendChild(option);
                });
            });
        } catch (error) {
            console.error('Erreur chargement équipes:', error);
            alert("Erreur lors du chargement des équipes: " + error.message);
        }
    }

    // Charger les données existantes au démarrage
    async function chargerConfigurationExistante() {
        try {
            const response = await fetch('/api/get-tournament');
            
            if (!response.ok) {
                throw new Error(`Erreur HTTP: ${response.status}`);
            }

            const config = await response.json();
            
            if (!config || !config.data) {
                console.warn('Aucune configuration trouvée, utilisation des valeurs par défaut');
                return;
            }

            // Remplir les groupes
            if (config.data.groupes) {
                for (const [groupe, equipes] of Object.entries(config.data.groupes)) {
                    const selects = document.querySelectorAll(`.${groupe}`);
                    equipes.forEach((equipe, index) => {
                        if (selects[index] && equipe.id) {
                            selects[index].value = equipe.id;
                            selects[index].dispatchEvent(new Event('change'));
                        }
                    });
                }
            }
            
            // Remplir les quarts de finale
            if (config.data.quarts) {
                config.data.quarts.forEach((quart, index) => {
                    const quartNum = index + 1;
                    const equipe1Select = document.getElementById(`quart${quartNum}_equipe1`);
                    const equipe2Select = document.getElementById(`quart${quartNum}_equipe2`);
                    
                    if (equipe1Select && quart.equipe1) {
                        equipe1Select.value = quart.equipe1;
                        equipe1Select.dispatchEvent(new Event('change'));
                    }
                    if (equipe2Select && quart.equipe2) {
                        equipe2Select.value = quart.equipe2;
                        equipe2Select.dispatchEvent(new Event('change'));
                    }
                });
            }
            
            // Remplir les demi-finales
            if (config.data.demis) {
                config.data.demis.forEach((demi, index) => {
                    const demiNum = index + 1;
                    const equipe1Select = document.getElementById(`demi${demiNum}_equipe1`);
                    const equipe2Select = document.getElementById(`demi${demiNum}_equipe2`);
                    
                    if (equipe1Select && demi.equipe1) {
                        equipe1Select.value = demi.equipe1;
                        equipe1Select.dispatchEvent(new Event('change'));
                    }
                    if (equipe2Select && demi.equipe2) {
                        equipe2Select.value = demi.equipe2;
                        equipe2Select.dispatchEvent(new Event('change'));
                    }
                });
            }
            
            // Remplir la finale
            if (config.data.finale) {
                const equipe1Select = document.getElementById('final_equipe1');
                const equipe2Select = document.getElementById('final_equipe2');
                
                if (equipe1Select && config.data.finale.equipe1) {
                    equipe1Select.value = config.data.finale.equipe1;
                    equipe1Select.dispatchEvent(new Event('change'));
                }
                if (equipe2Select && config.data.finale.equipe2) {
                    equipe2Select.value = config.data.finale.equipe2;
                    equipe2Select.dispatchEvent(new Event('change'));
                }
            }
            
            // Remplir le vainqueur
            if (config.data.vainqueur && config.data.vainqueur.id) {
                const vainqueurSelect = document.getElementById('vainqueur');
                if (vainqueurSelect) {
                    vainqueurSelect.value = config.data.vainqueur.id;
                    vainqueurSelect.dispatchEvent(new Event('change'));
                }
            }

        } catch (error) {
            console.error('Erreur chargement config:', error);
            alert('Erreur lors du chargement de la configuration: ' + error.message);
        }
    }

    // Connexion WebSocket
    const tournamentSocket = new WebSocket(`ws://${window.location.host}`);

    // Fonction pour envoyer les données en temps réel
    function updateLiveView() {
        const tournamentData = {
            groupes: {
                A: Array.from(document.querySelectorAll('.groupeA')).map(select => ({
                    id: select.value,
                    nom: select.options[select.selectedIndex]?.text || ''
                })),
                B: Array.from(document.querySelectorAll('.groupeB')).map(select => ({
                    id: select.value,
                    nom: select.options[select.selectedIndex]?.text || ''
                })),
                C: Array.from(document.querySelectorAll('.groupeC')).map(select => ({
                    id: select.value,
                    nom: select.options[select.selectedIndex]?.text || ''
                })),
                D: Array.from(document.querySelectorAll('.groupeD')).map(select => ({
                    id: select.value,
                    nom: select.options[select.selectedIndex]?.text || ''
                }))
            },
            arbre: {
                quarts: Array.from({ length: 4 }, (_, i) => ({
                    equipe1: document.getElementById(`quart${i+1}_equipe1`).value,
                    nom1: document.getElementById(`quart${i+1}_equipe1`).options[document.getElementById(`quart${i+1}_equipe1`).selectedIndex]?.text || '',
                    equipe2: document.getElementById(`quart${i+1}_equipe2`).value,
                    nom2: document.getElementById(`quart${i+1}_equipe2`).options[document.getElementById(`quart${i+1}_equipe2`).selectedIndex]?.text || ''
                })),
                demis: Array.from({ length: 2 }, (_, i) => ({
                    equipe1: document.getElementById(`demi${i+1}_equipe1`).value,
                    nom1: document.getElementById(`demi${i+1}_equipe1`).options[document.getElementById(`demi${i+1}_equipe1`).selectedIndex]?.text || '',
                    equipe2: document.getElementById(`demi${i+1}_equipe2`).value,
                    nom2: document.getElementById(`demi${i+1}_equipe2`).options[document.getElementById(`demi${i+1}_equipe2`).selectedIndex]?.text || ''
                })),
                finale: {
                    equipe1: document.getElementById('final_equipe1').value,
                    nom1: document.getElementById('final_equipe1').options[document.getElementById('final_equipe1').selectedIndex]?.text || '',
                    equipe2: document.getElementById('final_equipe2').value,
                    nom2: document.getElementById('final_equipe2').options[document.getElementById('final_equipe2').selectedIndex]?.text || ''
                },
                vainqueur: {
                    id: document.getElementById('vainqueur').value,
                    nom: document.getElementById('vainqueur').options[document.getElementById('vainqueur').selectedIndex]?.text || ''
                }
            }
        };

        if (tournamentSocket.readyState === WebSocket.OPEN) {
            tournamentSocket.send(JSON.stringify(tournamentData));
        } else {
            fetch('/api/update-live-view', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(tournamentData)
            }).catch(console.error);
        }
    }

    document.getElementById('saveTournament').addEventListener('click', async function() {
        const tournamentData = {
            groupes: {
                A: Array.from(document.querySelectorAll('.groupeA')).map(s => s.value),
                B: Array.from(document.querySelectorAll('.groupeB')).map(s => s.value),
                C: Array.from(document.querySelectorAll('.groupeC')).map(s => s.value),
                D: Array.from(document.querySelectorAll('.groupeD')).map(s => s.value)
            },
            quarts: Array.from({ length: 4 }, (_, i) => ({
                equipe1: document.getElementById(`quart${i+1}_equipe1`).value,
                equipe2: document.getElementById(`quart${i+1}_equipe2`).value
            })),
            demis: Array.from({ length: 2 }, (_, i) => ({
                equipe1: document.getElementById(`demi${i+1}_equipe1`).value,
                equipe2: document.getElementById(`demi${i+1}_equipe2`).value
            })),
            finale: {
                equipe1: document.getElementById('final_equipe1').value,
                equipe2: document.getElementById('final_equipe2').value
            },
            vainqueur: document.getElementById('vainqueur').value
        };

        try {
            const response = await fetch('/api/save-tournament', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(tournamentData)
            });

            if (!response.ok) throw new Error('Échec de la sauvegarde');
            alert('Données sauvegardées avec succès!');
        } catch (error) {
            alert('Erreur: ' + error.message);
        }
    });

    // Écouter les changements sur tous les selects
    document.querySelectorAll('.form-select').forEach(select => {
        select.addEventListener('change', updateLiveView);
    });

    // Gestion des erreurs WebSocket
    tournamentSocket.onerror = (error) => console.error('Erreur WebSocket:', error);
    tournamentSocket.onclose = () => console.log('Connexion WebSocket fermée');

    // Initialisation
    document.addEventListener('DOMContentLoaded', () => {
        chargerEquipes().then(chargerConfigurationExistante)
                       .then(() => setTimeout(updateLiveView, 1000));
    });
</script>
</body>
</html>